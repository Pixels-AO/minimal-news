<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Minimal News Digest</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: sans-serif;
    background: #f9f9f9;
    margin: 0; padding: 0;
    line-height: 1.4;
  }
  h1 {
    font-size: 1.2em;
    text-align: center;
    background: #333;
    color: white;
    padding: 10px;
    margin: 0;
  }
  section {
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }
  h2 {
    font-size: 1em;
    margin-top: 0;
    color: #444;
  }
  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  li {
    margin-bottom: 6px;
  }
  a {
    text-decoration: none;
    color: #0066cc;
  }
  a:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<h1>Today's Headlines</h1>

<section id="bbc">
  <h2>BBC News</h2>
  <ul></ul>
</section>

<section id="aj">
  <h2>Al Jazeera</h2>
  <ul></ul>
</section>

<script>
const feeds = {
  bbc: "http://feeds.bbci.co.uk/news/rss.xml",
  aj: "https://www.aljazeera.com/xml/rss/all.xml"
};

const CACHE_KEY = 'minimalNewsCache';
const CACHE_TIME_KEY = 'minimalNewsCacheTime';

// Fixed update times in hours (24-hour format)
const UPDATE_TIMES = [9, 14, 20];

function loadCachedOrFetch() {
  const now = new Date();
  const cachedData = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
  const lastFetch = parseInt(localStorage.getItem(CACHE_TIME_KEY), 10) || 0;
  const lastFetchDate = new Date(lastFetch);

  if (!shouldUpdate(now, lastFetchDate) && Object.keys(cachedData).length) {
    console.log("Using cached headlines");
    displayHeadlines(cachedData);
    return;
  }

  console.log("Fetching fresh headlines");
  fetchAllFeeds()
    .then(data => {
      if (data.bbc.length && data.aj.length) {
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        localStorage.setItem(CACHE_TIME_KEY, now.getTime().toString());
        displayHeadlines(data);
      } else {
        console.warn("Fetch returned empty data, using cache instead");
        if (Object.keys(cachedData).length) displayHeadlines(cachedData);
      }
    })
    .catch(err => {
      console.error("Fetch failed:", err);
      if (Object.keys(cachedData).length) displayHeadlines(cachedData);
    });
}

function shouldUpdate(now, lastFetchDate) {
  // Find the last scheduled update time before "now"
  const lastScheduled = getLastScheduledTime(now);
  return lastFetchDate.getTime() < lastScheduled.getTime();
}

function getLastScheduledTime(date) {
  const today = new Date(date);
  today.setMinutes(0, 0, 0);

  for (let i = UPDATE_TIMES.length - 1; i >= 0; i--) {
    if (date.getHours() >= UPDATE_TIMES[i]) {
      today.setHours(UPDATE_TIMES[i]);
      return today;
    }
  }
  // If it's before the first scheduled time, go back to yesterday's last time
  today.setDate(today.getDate() - 1);
  today.setHours(UPDATE_TIMES[UPDATE_TIMES.length - 1]);
  return today;
}

function fetchAllFeeds() {
  return Promise.all([
    fetchFeed(feeds.bbc),
    fetchFeed(feeds.aj)
  ]).then(([bbcData, ajData]) => ({
    bbc: bbcData,
    aj: ajData
  }));
}

function fetchFeed(url) {
  const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`;
  return fetch(apiUrl)
    .then(res => res.json())
    .then(data => data.items ? data.items.slice(0, 5) : [])
    .catch(() => []);
}

function displayHeadlines(data) {
  ['bbc', 'aj'].forEach(source => {
    const ul = document.querySelector(`#${source} ul`);
    ul.innerHTML = '';
    (data[source] || []).forEach(item => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.textContent = item.title;
      a.href = item.link;
      a.target = '_blank';
      li.appendChild(a);
      ul.appendChild(li);
    });
  });
}

loadCachedOrFetch();
</script>

</body>
</html>

